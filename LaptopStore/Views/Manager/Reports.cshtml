@{
    ViewData["Title"] = "Thống kê doanh thu";
    ViewData["Subtitle"] = "Phân tích và báo cáo kinh doanh";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<!-- Page Header -->
<div class="page-header">
    <div class="page-header-left">
        <h2>Thống kê doanh thu</h2>
        <p>Phân tích hiệu suất kinh doanh và xu hướng bán hàng</p>
    </div>
    <div class="page-header-right">
        <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="exportReport('pdf')">
                <i class="fas fa-file-pdf"></i>
                <span class="d-none d-md-inline ms-1">Xuất PDF</span>
            </button>
            <a href="@Url.Action("ExportExcel")" class="btn btn-secondary">
                <i class="fas fa-file-excel"></i>
                <span class="d-none d-md-inline ms-1">Xuất Excel</span>
            </a>
        </div>
    </div>
</div>

<!-- Revenue Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-details">
                <div class="stat-label">Tổng doanh thu</div>
                <div class="stat-value">@((decimal)ViewBag.TotalRevenue / 1000000)M</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    Tất cả thời gian
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-details">
                <div class="stat-label">Doanh thu tháng này</div>
                <div class="stat-value">@((decimal)ViewBag.MonthlyRevenue / 1000000)M</div>
                <div class="stat-change @(ViewBag.RevenueGrowth >= 0 ? "positive" : "negative")">
                    <i class="fas fa-arrow-@(ViewBag.RevenueGrowth >= 0 ? "up" : "down")"></i>
                    @ViewBag.RevenueGrowth.ToString("F1")% so với tháng trước
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-details">
                <div class="stat-label">Đơn hàng hoàn thành</div>
                <div class="stat-value">@ViewBag.CompletedOrders</div>
                <div class="stat-change">
                    <span class="text-muted">@ViewBag.TotalOrders tổng đơn</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card stat-warning">
            <div class="stat-icon">
                <i class="fas fa-receipt"></i>
            </div>
            <div class="stat-details">
                <div class="stat-label">Giá trị đơn trung bình</div>
                <div class="stat-value">@((decimal)ViewBag.AvgOrderValue / 1000000)M</div>
                <div class="stat-change">
                    <span class="text-muted">Per order</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Revenue Chart -->
    <div class="col-12 col-xl-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Biểu đồ doanh thu
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-secondary chart-period" data-period="week">7 ngày</button>
                    <button type="button" class="btn btn-primary chart-period active" data-period="month">30 ngày</button>
                    <button type="button" class="btn btn-secondary chart-period" data-period="year">Năm</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Status Distribution -->
    <div class="col-12 col-xl-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    Phân bố đơn hàng
                </h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="chart-container flex-grow-1" style="max-height: 250px;">
                    <canvas id="orderStatusChart"></canvas>
                </div>
                <div class="mt-3">
                    @{
                        var ordersByStatus = ViewBag.OrdersByStatus as dynamic;
                    }
                    @if (ordersByStatus != null)
                    {
                        <div class="d-flex flex-wrap gap-3 justify-content-center">
                            @foreach (var item in ordersByStatus)
                            {
                                var statusName = item.Status switch
                                {
                                    "pending" => "Chờ xác nhận",
                                    "processing" => "Đang xử lý",
                                    "shipping" => "Đang giao",
                                    "delivered" => "Đã giao",
                                    "cancelled" => "Đã hủy",
                                    _ => item.Status
                                };
                                var statusColor = item.Status switch
                                {
                                    "pending" => "#f59e0b",
                                    "processing" => "#3b82f6",
                                    "shipping" => "#8b5cf6",
                                    "delivered" => "#10b981",
                                    "cancelled" => "#ef4444",
                                    _ => "#6b7280"
                                };
                                <div class="d-flex align-items-center gap-2">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background: @statusColor;"></span>
                                    <small>@statusName: @item.Count</small>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Top Products -->
    <div class="col-12 col-xl-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-trophy"></i>
                    Top 10 sản phẩm bán chạy
                </h5>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Sản phẩm</th>
                            <th class="text-center">Số lượng bán</th>
                            <th class="text-end">Doanh thu</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var topProducts = ViewBag.TopProducts as dynamic;
                            var rank = 1;
                        }
                        @if (topProducts != null)
                        {
                            foreach (var product in topProducts)
                            {
                                var rankClass = rank switch
                                {
                                    1 => "gold",
                                    2 => "silver",
                                    3 => "bronze",
                                    _ => ""
                                };
                                <tr>
                                    <td>
                                        <span class="rank-badge @rankClass">@rank</span>
                                    </td>
                                    <td>
                                        <a href="@Url.Action("Details", "ProductManagement", new { id = product.ProductId })" 
                                           style="color: var(--text-primary); text-decoration: none; font-weight: 500;">
                                            @product.ProductName
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-light">@product.TotalQuantity</span>
                                    </td>
                                    <td class="text-end fw-bold text-primary">
                                        @((decimal)product.TotalRevenue / 1000000)M ₫
                                    </td>
                                </tr>
                                rank++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    Chưa có dữ liệu sản phẩm
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Payment Methods -->
    <div class="col-12 col-xl-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-credit-card"></i>
                    Phương thức thanh toán
                </h5>
            </div>
            <div class="card-body">
                @{
                    var revenueByPayment = ViewBag.RevenueByPayment as dynamic;
                }
                @if (revenueByPayment != null)
                {
                    foreach (var payment in revenueByPayment)
                    {
                        var methodName = payment.Method switch
                        {
                            "cod" => "Thanh toán khi nhận hàng (COD)",
                            "vietqr" => "Chuyển khoản ngân hàng",
                            "vnpay" => "Ví điện tử VNPay",
                            _ => payment.Method ?? "Khác"
                        };
                        var methodIcon = payment.Method switch
                        {
                            "cod" => "fa-money-bill-wave",
                            "vietqr" => "fa-university",
                            "vnpay" => "fa-wallet",
                            _ => "fa-credit-card"
                        };
                        var totalRevenue = (decimal)ViewBag.TotalRevenue;
                        var percentage = totalRevenue > 0 ? ((decimal)payment.Revenue / totalRevenue) * 100 : 0;

                        <div class="payment-method-item mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="fas @methodIcon text-primary"></i>
                                    <span class="fw-medium">@methodName</span>
                                </div>
                                <span class="fw-bold">@((decimal)payment.Revenue / 1000000)M ₫</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: @percentage%; background: var(--primary-500);"
                                     aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">@payment.Count đơn hàng</small>
                                <small class="text-muted">@percentage.ToString("F1")%</small>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        Chưa có dữ liệu thanh toán
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-4">
    <div class="col-12 col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <span class="stat-icon-lg bg-success-light text-success">
                        <i class="fas fa-check-circle"></i>
                    </span>
                </div>
                <h3 class="mb-1">@ViewBag.CompletedOrders</h3>
                <p class="text-muted mb-0">Đơn hàng hoàn thành</p>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <span class="stat-icon-lg bg-warning-light text-warning">
                        <i class="fas fa-clock"></i>
                    </span>
                </div>
                <h3 class="mb-1">@ViewBag.PendingOrders</h3>
                <p class="text-muted mb-0">Đơn hàng chờ xử lý</p>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <span class="stat-icon-lg bg-danger-light text-danger">
                        <i class="fas fa-times-circle"></i>
                    </span>
                </div>
                <h3 class="mb-1">@ViewBag.CancelledOrders</h3>
                <p class="text-muted mb-0">Đơn hàng đã hủy</p>
            </div>
        </div>
    </div>
</div>

<style>
    .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 0.8rem;
    }
    
    .rank-badge.gold {
        background: linear-gradient(135deg, #ffd700, #ffb800);
        color: #7a5800;
    }
    
    .rank-badge.silver {
        background: linear-gradient(135deg, #e8e8e8, #c0c0c0);
        color: #555;
    }
    
    .rank-badge.bronze {
        background: linear-gradient(135deg, #d4a574, #cd7f32);
        color: #5a3d1a;
    }
    
    .stat-icon-lg {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        font-size: 1.5rem;
    }
    
    .bg-success-light {
        background: var(--success-100);
    }
    
    .bg-warning-light {
        background: var(--warning-100);
    }
    
    .bg-danger-light {
        background: rgba(239, 68, 68, 0.1);
    }
    
    .text-warning {
        color: var(--warning-600) !important;
    }
    
    .text-danger {
        color: #ef4444 !important;
    }
    
    .progress {
        background: var(--bg-tertiary);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .progress-bar {
        border-radius: 4px;
        transition: width 0.6s ease;
    }
    
    .chart-period.active {
        background: var(--primary-500) !important;
        border-color: var(--primary-500) !important;
        color: white !important;
    }
    
    .chart-container {
        position: relative;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        let revenueChart;
        
        const monthlyLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.MonthlyLabels ?? new List<string>()));
        const monthlyRevenues = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.MonthlyRevenues ?? new List<decimal>()));
        
        function initRevenueChart(labels, data) {
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu',
                        data: data,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'rgb(99, 102, 241)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh thu: ' + (context.raw / 1000000).toFixed(1) + 'M ₫';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        initRevenueChart(monthlyLabels, monthlyRevenues);
        
        // Chart period buttons
        document.querySelectorAll('.chart-period').forEach(btn => {
            btn.addEventListener('click', async function() {
                document.querySelectorAll('.chart-period').forEach(b => {
                    b.classList.remove('active', 'btn-primary');
                    b.classList.add('btn-secondary');
                });
                this.classList.remove('btn-secondary');
                this.classList.add('active', 'btn-primary');
                
                const period = this.dataset.period;
                try {
                    const response = await fetch(`/Reports/GetRevenueData?period=${period}`);
                    const data = await response.json();
                    const labels = data.map(d => d.date);
                    const revenues = data.map(d => d.revenue);
                    initRevenueChart(labels, revenues);
                } catch (error) {
                    console.error('Error fetching revenue data:', error);
                }
            });
        });
        
        // Order Status Chart
        const orderStatusCtx = document.getElementById('orderStatusChart').getContext('2d');
        const orderStatusData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.OrdersByStatus ?? new List<object>()));
        
        new Chart(orderStatusCtx, {
            type: 'doughnut',
            data: {
                labels: orderStatusData.map(d => {
                    switch(d.status) {
                        case 'pending': return 'Chờ xác nhận';
                        case 'processing': return 'Đang xử lý';
                        case 'shipping': return 'Đang giao';
                        case 'delivered': return 'Đã giao';
                        case 'cancelled': return 'Đã hủy';
                        default: return d.status;
                    }
                }),
                datasets: [{
                    data: orderStatusData.map(d => d.count),
                    backgroundColor: orderStatusData.map(d => {
                        switch(d.status) {
                            case 'pending': return '#f59e0b';
                            case 'processing': return '#3b82f6';
                            case 'shipping': return '#8b5cf6';
                            case 'delivered': return '#10b981';
                            case 'cancelled': return '#ef4444';
                            default: return '#6b7280';
                        }
                    }),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Export functions
        function exportReport(type) {
            alert(`Tính năng xuất ${type.toUpperCase()} đang được phát triển`);
        }
    </script>
}
