@model LaptopStore.Models.Cart
@{
    ViewData["Title"] = "Thanh toán";
    var cartItems = Model?.CartItems ?? new List<CartItem>();
    decimal subtotal = 0;
    if (cartItems.Any())
    {
        subtotal = cartItems.Sum(ci => (ci.Quantity ?? 0) * (ci.Product?.Price ?? 0));
    }
    decimal shippingFee = 0;
    decimal total = subtotal + shippingFee;

    // Estimated delivery: hôm nay + processing + 3-5 ngày
    var processingDays = 1;
    var shippingMinDays = 3;
    var shippingMaxDays = 5;
    var today = DateTime.Now.Date;
    var estFrom = today.AddDays(processingDays + shippingMinDays);
    var estTo = today.AddDays(processingDays + shippingMaxDays);
}

<link rel="stylesheet" href="~/css/cart.css" />
<link rel="stylesheet" href="~/css/checkout.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<section class="h-100 gradient-custom">
    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="fw-bold text-dark">Thanh toán</h2>
                <p class="text-muted">Vui lòng điền thông tin để hoàn tất đơn hàng</p>
            </div>
        </div>

        <!-- CHỈNH: form action trỏ tới OrderController -->
        <form id="checkout-form" method="post" action="/Order/PlaceOrder">
            <input type="hidden" name="userId" value="@(Model?.UserId ?? 2)" />
            
            <div class="row">
                <!-- Cột Trái: Form nhập liệu (60-70%) -->
                <div class="col-lg-8 col-md-7">
                    <!-- Thông tin người nhận -->
                    <div class="card mb-4">
                        <div class="card-header py-3">
                            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Thông tin người nhận</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="fullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="fullName" name="fullName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phoneNumber" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" placeholder="Để nhận xác nhận đơn hàng">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Địa chỉ giao hàng -->
                    <div class="card mb-4">
                        <div class="card-header py-3">
                            <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ giao hàng</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="province" class="form-label">Tỉnh / Thành phố <span class="text-danger">*</span></label>
                                    <select class="form-select" id="province" name="province" required>
                                        <option value="">-- Chọn Tỉnh/Thành phố --</option>
                                        <option value="Hà Nội">Hà Nội</option>
                                        <option value="TP. Hồ Chí Minh">TP. Hồ Chí Minh</option>
                                        <option value="Đà Nẵng">Đà Nẵng</option>
                                        <option value="Hải Phòng">Hải Phòng</option>
                                        <option value="Cần Thơ">Cần Thơ</option>
                                        <option value="An Giang">An Giang</option>
                                        <option value="Bà Rịa - Vũng Tàu">Bà Rịa - Vũng Tàu</option>
                                        <option value="Bắc Giang">Bắc Giang</option>
                                        <option value="Bắc Kạn">Bắc Kạn</option>
                                        <option value="Bạc Liêu">Bạc Liêu</option>
                                        <option value="Bắc Ninh">Bắc Ninh</option>
                                        <option value="Bến Tre">Bến Tre</option>
                                        <option value="Bình Định">Bình Định</option>
                                        <option value="Bình Dương">Bình Dương</option>
                                        <option value="Bình Phước">Bình Phước</option>
                                        <option value="Bình Thuận">Bình Thuận</option>
                                        <option value="Cà Mau">Cà Mau</option>
                                        <option value="Cao Bằng">Cao Bằng</option>
                                        <option value="Đắk Lắk">Đắk Lắk</option>
                                        <option value="Đắk Nông">Đắk Nông</option>
                                        <option value="Điện Biên">Điện Biên</option>
                                        <option value="Đồng Nai">Đồng Nai</option>
                                        <option value="Đồng Tháp">Đồng Tháp</option>
                                        <option value="Gia Lai">Gia Lai</option>
                                        <option value="Hà Giang">Hà Giang</option>
                                        <option value="Hà Nam">Hà Nam</option>
                                        <option value="Hà Tĩnh">Hà Tĩnh</option>
                                        <option value="Hải Dương">Hải Dương</option>
                                        <option value="Hậu Giang">Hậu Giang</option>
                                        <option value="Hòa Bình">Hòa Bình</option>
                                        <option value="Hưng Yên">Hưng Yên</option>
                                        <option value="Khánh Hòa">Khánh Hòa</option>
                                        <option value="Kiên Giang">Kiên Giang</option>
                                        <option value="Kon Tum">Kon Tum</option>
                                        <option value="Lai Châu">Lai Châu</option>
                                        <option value="Lâm Đồng">Lâm Đồng</option>
                                        <option value="Lạng Sơn">Lạng Sơn</option>
                                        <option value="Lào Cai">Lào Cai</option>
                                        <option value="Long An">Long An</option>
                                        <option value="Nam Định">Nam Định</option>
                                        <option value="Nghệ An">Nghệ An</option>
                                        <option value="Ninh Bình">Ninh Bình</option>
                                        <option value="Ninh Thuận">Ninh Thuận</option>
                                        <option value="Phú Thọ">Phú Thọ</option>
                                        <option value="Phú Yên">Phú Yên</option>
                                        <option value="Quảng Bình">Quảng Bình</option>
                                        <option value="Quảng Nam">Quảng Nam</option>
                                        <option value="Quảng Ngãi">Quảng Ngãi</option>
                                        <option value="Quảng Ninh">Quảng Ninh</option>
                                        <option value="Quảng Trị">Quảng Trị</option>
                                        <option value="Sóc Trăng">Sóc Trăng</option>
                                        <option value="Sơn La">Sơn La</option>
                                        <option value="Tây Ninh">Tây Ninh</option>
                                        <option value="Thái Bình">Thái Bình</option>
                                        <option value="Thái Nguyên">Thái Nguyên</option>
                                        <option value="Thanh Hóa">Thanh Hóa</option>
                                        <option value="Thừa Thiên Huế">Thừa Thiên Huế</option>
                                        <option value="Tiền Giang">Tiền Giang</option>
                                        <option value="Trà Vinh">Trà Vinh</option>
                                        <option value="Tuyên Quang">Tuyên Quang</option>
                                        <option value="Vĩnh Long">Vĩnh Long</option>
                                        <option value="Vĩnh Phúc">Vĩnh Phúc</option>
                                        <option value="Yên Bái">Yên Bái</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="district" class="form-label">Quận / Huyện <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="district" name="district" required>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label for="address" class="form-label">Địa chỉ cụ thể <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="address" name="address" placeholder="Số nhà, tên đường" required>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label for="note" class="form-label">Ghi chú đơn hàng</label>
                                    <textarea class="form-control" id="note" name="note" rows="3" placeholder="Ví dụ: Giao giờ hành chính"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phương thức thanh toán -->
                    <div class="card mb-4">
                        <div class="card-header py-3">
                            <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Phương thức thanh toán</h5>
                        </div>
                        <div class="card-body">
                            <!-- sửa giá trị radio thành mã phù hợp với DB -->
<div class="form-check mb-3 payment-option">
    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCOD" value="cod" checked>
    <label class="form-check-label" for="paymentCOD">
        <strong>Thanh toán khi nhận hàng (COD)</strong>
        <p class="text-muted small mb-0">Bạn sẽ thanh toán khi nhận được hàng</p>
    </label>
</div>
<div class="form-check payment-option">
    <input class="form-check-input" type="radio" name="paymentMethod" id="paymentBank" value="vietqr">
    <label class="form-check-label" for="paymentBank">
        <strong>Chuyển khoản ngân hàng (QR Code)</strong>
        <p class="text-muted small mb-0">Quét mã QR để thanh toán nhanh chóng</p>
    </label>
</div>
                        </div>
                    </div>
                </div>

                <!-- Cột Phải: Tóm tắt đơn hàng (30-40%) -->
                <div class="col-lg-4 col-md-5">
                    <div class="card mb-4 sticky-top" style="top: 20px;">
                        <div class="card-header py-3">
                            <h5 class="mb-0">Tóm tắt đơn hàng</h5>
                        </div>
                        <div class="card-body">
                            <!-- Danh sách sản phẩm rút gọn -->
                            <div class="checkout-items mb-3">
                                @foreach (var item in cartItems)
                                {
                                    var product = item.Product;
                                    var quantity = item.Quantity ?? 1;
                                    var price = product?.Price ?? 0;
                                    var itemTotal = quantity * price;
                                    
                                    <div class="checkout-item mb-2 pb-2 border-bottom">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <p class="mb-1 fw-semibold small">@product?.Name</p>
                                                <p class="mb-0 text-muted small">Số lượng: @quantity</p>
                                            </div>
                                            <div class="text-end">
                                                <p class="mb-0 fw-bold text-primary">@itemTotal.ToString("N0") đ</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            </div>

                            <!-- Tính tiền -->
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0 summary-item">
                                    Tạm tính
                                    <span id="subtotal-amount">@subtotal.ToString("N0") đ</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0 summary-item">
                                    Phí vận chuyển
                                    <span id="shipping-fee">
                                        @if (shippingFee == 0)
                                        {
                                            <span class="text-success">Miễn phí</span>
                                        }
                                        else
                                        {
                                            <span>@shippingFee.ToString("N0") đ</span>
                                        }
                                    </span>
                                </li>

                                <li class="list-group-item">
                                    <strong>Dự kiến giao hàng</strong>
                                    <div class="text-success small"><i class="fas fa-truck me-2"></i>@estFrom.ToString("dd.MM.yyyy") - @estTo.ToString("dd.MM.yyyy")</div>
                                </li>

                                <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3 summary-item">
                                    <div>
                                        <strong>Tổng cộng</strong>
                                        <p class="mb-0 text-muted small">(Đã bao gồm VAT)</p>
                                    </div>
                                    <span class="summary-total" id="total-amount"><strong>@total.ToString("N0") đ</strong></span>
                                </li>
                            </ul>

                            <!-- Nút đặt hàng -->
                            <button type="submit" class="btn btn-primary btn-checkout btn-lg btn-block w-100" id="btn-place-order">
                                <i class="fas fa-shopping-bag me-2"></i>ĐẶT HÀNG
                            </button>

                            <div class="mt-3 text-center">
                                <a href="/Cart/CartView" class="text-muted text-decoration-none small">
                                    <i class="fas fa-arrow-left me-1"></i> Quay lại giỏ hàng
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<script>
    // Tính phí vận chuyển khi chọn tỉnh/thành phố
    var provinceEl = document.getElementById('province');
    if (provinceEl) {
        provinceEl.addEventListener('change', function() {
            var province = this.value;
            if (province) {
                fetch('/Cart/CalculateShipping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'province=' + encodeURIComponent(province)
                })
                .then(response => response.json())
                .then(data => {
                    var subtotal = @subtotal;
                    var shippingFee = data.shippingFee;
                    var total = subtotal + shippingFee;
                    
                    var shippingElement = document.getElementById('shipping-fee');
                    if (shippingFee == 0) {
                        shippingElement.innerHTML = '<span class="text-success">Miễn phí</span>';
                    } else {
                        shippingElement.innerHTML = formatCurrency(shippingFee);
                    }
                    
                    document.getElementById('total-amount').innerHTML = '<strong>' + formatCurrency(total) + '</strong>';
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        });
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount) + ' đ';
    }

    // Xử lý submit form
    var checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            var btn = document.getElementById('btn-place-order');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
            
            var formData = new FormData(this);
            var formBody = [];
            for (var pair of formData.entries()) {
                formBody.push(encodeURIComponent(pair[0]) + '=' + encodeURIComponent(pair[1]));
            }
            
            // CHỈNH: gọi OrderController.PlaceOrder
            fetch('/Order/PlaceOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest' // ← thêm header này
                },
                body: formBody.join('&')
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to order details (server trả redirectUrl)
                    if (data.redirectUrl) {
                        window.location.href = data.redirectUrl;
                        return;
                    }
                    alert(data.message || 'Đặt hàng thành công!');
                    window.location.href = '/';
                } else {
                    alert(data.message || 'Có lỗi xảy ra khi đặt hàng');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-shopping-bag me-2"></i>ĐẶT HÀNG';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi đặt hàng');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shopping-bag me-2"></i>ĐẶT HÀNG';
            });
        });
    }
</script>
